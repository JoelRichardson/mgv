<template>
  <div class="list-editor">
    <form>
      <table>
        <tr>
          <td><label>Name</label></td>
          <td><input name="name" v-model="name" /></td>
        </tr>
        <tr>
          <td><label>Description</label></td>
          <td><textarea name="description" v-model="description" placeholder="Description of this list."/></td>
        </tr>
        <tr>
          <td><label>Color</label></td>
          <td>
            <div class="flexcolumn">
              <div class="swatch"
                :style="{ backgroundColor: color }"
                @click="togglePicker"
                :title="`Click to ${pickerOpen ? 'close' : 'open'} the color picker.`"
                />
              <color-picker
                v-show="pickerOpen"
                v-model="pickerColor"
                style="max-width: 200px;"
                />
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <div class="flexcolumn">
              <label>Items</label>
              <span>({{items.length}})</span>
            </div>
          </td>
          <td>
            <textarea 
               v-model="itemsText"
               ref="textarea"
               name="items"
               rows=10
               @dragover="dragover"
               @dragleave="dragleave"
               @drop="drop"
               :disabled="formula.length > 0"
               />
          </td>
        </tr>
        <tr>
         <td></td>
         <td>
           <div class="flexrow dropzone">
             <div
               name="union"
               class="listop"
               title="DRAG a list here to ADD its items to this list. CLICK here to add the current selection."
               @dragover="dragover"
               @dragleave="dragleave"
               @drop="drop"
               @click="addSelected"
               >
                 <div class="circle c1"></div>
                 <div class="circle c2"></div>
                 <label>union</label>
               </div>
             <div
               name="intersection"
               class="listop"
               title="DRAG a list here to INTERSECT its items with this list. CLICK here to intersect with the current selection."
               @dragover="dragover"
               @dragleave="dragleave"
               @drop="drop"
               @click="intersectWithSelected"
               >
                 <div class="circle c1"></div>
                 <div class="circle c2"></div>
                 <label>intersection</label>
               </div>
             <div
               name="difference"
               class="listop"
               title="DRAG a list here to REMOVE its items from this list. CLICK here to remove the current selection."
               @dragover="dragover"
               @dragleave="dragleave"
               @drop="drop"
               @click="removeSelected"
               >
                 <div class="circle c1"></div>
                 <div class="circle c2"></div>
                 <label>difference</label>
               </div>
           </div>
         </td>
        </tr>
        <tr>
          <td><label>Formula</label>
              <br/>
              <m-button
                  icon="refresh"
                  title="Click to refresh the list (replay the formula)."
                  @click="refreshList"
                  :disabled="formula.length === 0"
                  />
          </td>
          <td><textarea
                name="formula"
                :class="{
                  valid: formulaValid === true,
                  invalid: formulaValid !== true && formulaValid !== null
                }"
                v-model="formula"
                placeholder=""/>
                <span
                  v-if="formulaError"
                  >{{formulaError}}</span>
          </td>
        </tr>
        <tr class="date">
          <td><label>Created</label></td>
          <td><span>{{ created }}</span></td>
        </tr>
        <tr class="date">
          <td><label>Modified</label></td>
          <td><span>{{ modified }}</span></td>
        </tr>
        <tr>
          <td colspan=2>
            <button type="button" value="cancel" @click="cancel">Cancel</button>
            <button v-if="list" type="button" value="save" @click="save">Save</button>
            <button v-if="!list" type="button" value="create" @click="create">Create</button>
          </td>
        </tr>
      </table>
    </form>
  </div>
</template>

<script>
import MComponent from '@/components/MComponent'
import MButton from '@/components/MButton'
import { Chrome } from 'vue-color'
import ListFormulaEvaluator from '@/lib/ListFormulaEvaluator'
export default MComponent({
  name: 'ListEditor',
  components: {
    MButton,
    ColorPicker: Chrome
  },
  props: {
    list: Object
  },
  inject: ['listManager','externalQueries'],
  data: function () {
    return {
      name: '',
      created: '',
      modified: '',
      description: '',
      formula: '',
      formulaError: '',
      color: '#000000',
      items: [],
      pickerOpen: false,
      pickerColor: { hex8: '#000000ff' }
    }
  },
  computed: {
    itemsText: {
      get: function () {
        return this.items.join('\n')
      },
      set: function (val) {
        // let v = this.$refs.textarea.value
        // let titems = v.split(/\s+/).filter(x => x)
      }
    },
    formulaValid () {
      const v = this.lfe.isValid(this.formula)
      if (typeof(v) === "string") {
        this.formulaError = v
      } else {
        this.formulaError = ""
      }
      return v
    }
  },
  watch: {
    list: function () {
      this.reset()
    },
    pickerColor: function (c) {
      this.color = c.hex8 || c
    }
  },
  created: function () {
    this.lfe = new ListFormulaEvaluator(this.listManager(), this.externalQueries())
  },
  mounted: function () {
    this.app.$root.$on('list-delete', d => {
      if (this.list === d) {
        this.cancel()
      }
    })
  },
  methods: {
    open: function () {
      this.closePicker()
      this.$parent.open()
      this.reset()
    },
    close: function () {
      this.$parent.close()
    },
    openPicker: function () {
      this.pickerOpen = true
    },
    closePicker: function () {
      this.pickerOpen = false
    },
    togglePicker: function () {
      this.pickerOpen = !this.pickerOpen
    },
    getDropTarget: function (evt) {
      if (evt.target.tagName.toLowerCase() === 'textarea') {
        return evt.target
      }
      return evt.target.closest('.dropzone > div')
    },
    dragover: function (evt) {
      evt.preventDefault()
      this.getDropTarget(evt).className = 'candrop'
    },
    dragleave: function (evt) {
      this.getDropTarget(evt).className = ''
    },
    drop: function (evt) {
      evt.preventDefault()
      this.dragleave(evt)
      let dt = evt.dataTransfer
      let listName = dt.getData('text')
      let list = this.listManager().getList(listName)
      let dtgt = this.getDropTarget(evt)
      let op = dtgt.getAttribute('name')
      let ops = {
        intersection: '*',
        union: '+',
        difference: '-',
        items: 'replace'
      }
      if (this.formula) {
        this.formula = this.lfe.parser.format(this.lfe.parser.parse(`(${this.formula}) ${ops[op]} "${list.name}"`))
      } else {
        this.formula = `"${list.name}"`
      }
      this.refreshList()
    },
    reset: function () {
      if (this.list) {
        let l = this.list
        this.name = l.name
        this.description = l.description
        this.formula = l.formula
        this.color = l.color
        this.created = l.created.toDateString() + ' ' + l.created.toLocaleTimeString()
        this.modified = l.modified.toDateString() + ' ' + l.modified.toLocaleTimeString()
        this.items = JSON.parse(JSON.stringify(l.items))
        this.pickerOpen = false
        this.pickerColor = this.color
        this.$parent.open()
      } else {
        this.name = ''
        this.formula = ''
        this.description = ''
        this.color = '#000000'
        this.created = ''
        this.modified = ''
        this.items = []
        this.pickerOpen = false
        this.pickerColor = this.color
      }
    },
    save: function () {
      let tv = this.$refs.textarea.value
      this.items = tv.split(/\s+/).filter(x => x)
      this.$root.$emit('list-edit-save', this.$data)
      this.$parent.close()
    },
    create: function () {
      let tv = this.$refs.textarea.value
      this.items = tv.split(/\s+/).filter(x => x)
      this.$root.$emit('list-edit-new', this.$data)
      this.$parent.close()
    },
    clear: function () {
      this.$root.$emit('list-edit-cancel')
    },
    cancel: function () {
      this.$root.$emit('list-edit-cancel')
      this.$parent.close()
    },
    replace: function (lst) {
      this.items = []
      this.union(lst)
    },
    union: function (lst) {
      let s = new Set(this.items)
      lst.items.forEach(i => s.add(i))
      this.items = Array.from(s)
    },
    difference: function (lst) {
      let s = new Set(this.items)
      lst.items.forEach(i => s.delete(i))
      this.items = Array.from(s)
    },
    intersection: function (lst) {
      let s = new Set(this.items)
      let ss = new Set()
      lst.items.forEach(i => s.has(i) && ss.add(i))
      this.items = Array.from(ss)
    },
    addSelected: function () {
      this.union({items:this.app.currentSelection})
    },
    removeSelected: function () {
      this.difference({items:this.app.currentSelection})
    },
    intersectWithSelected: function () {
      this.intersection({items:this.app.currentSelection})
    },
    refreshList: function (e) {
      this.lfe.refreshList(this.$data, e && e.shiftKey).then(ids => this.items = ids)
    }
  }
})
</script>

<style scoped>
.list-editor {
  max-width: 300px;
}
.date {
  font-size: 12px;
}
.swatch {
  height: 20px;
  cursor: pointer;
}
table {
  width: 100%;
}
td:nth-child(2) * {
  width: 100%;
}
textarea {
  resize: vertical;
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  box-sizing: content-box;
}
.valid {
  outline: 5px auto green;
  outline-offset: -2px;
}
.invalid {
  outline: 5px auto red;
  outline-offset: -2px;
}
.dropzone {
  font-size: 48px;
}
.dropzone > div {
  position: relative;
  border: thin solid #aaa;
  height: 60px;
  width: 60px;
}
.dropzone label {
  font-size: 10px;
}
.candrop {
  background-color: green;
}
.circle {
  height: 20px !important;
  width: 20px !important;
  border-radius: 10px;
  background-color: blue;
  position: absolute;
  top: 22px;
  left: 18px;
}
.circle.c2 {
  left: 28px;
}
.listop:hover {
  color: black;
  border-color: black;
}
[name="union"] .circle {
  opacity: 0.9;
}
[name="intersection"] .circle {
  opacity: 0.5;
}
[name="difference"] .circle.c2 {
  background-color: #cccccceb;
}
</style>
